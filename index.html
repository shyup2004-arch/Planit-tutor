<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í”Œëœì‡ íŠœí„° (Planit-tutor)</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Noto+Sans+KR:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', 'Noto Sans KR', sans-serif; }
        .fade-in { animation: fadeIn 0.5s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0, 0, 0, 0.6); display: flex; justify-content: center; align-items: center; z-index: 1000; }
        
        /* í”Œë˜ë„ˆìš© ìŠ¤íƒ€ì¼ */
        .task-item[data-status="2"] .task-text { text-decoration: line-through; color: #9ca3af; }
        .task-item[data-status="1"] .task-text { color: #3b82f6; font-style: italic; }
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        .plan-item.active { background-color: #eff6ff; color: #2563eb; font-weight: 600; }
        .plan-item .delete-plan-btn { opacity: 0; transition: opacity 0.2s ease-in-out; }
        .plan-item:hover .delete-plan-btn { opacity: 1; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ë¡œê·¸ì¸ í™”ë©´ -->
    <div id="login-container" class="flex flex-col justify-center items-center h-screen">
        <h1 class="text-4xl font-bold mb-2">ğŸš€ Planit-tutor</h1>
        <p class="text-gray-600 mb-8">ì„ ìƒë‹˜ê³¼ í•™ìƒì„ ìœ„í•œ ìƒˆë¡œìš´ í•™ìŠµ ê´€ë¦¬</p>
        <button id="login-btn" class="bg-white text-gray-700 font-semibold py-3 px-6 border border-gray-300 rounded-lg shadow-sm hover:bg-gray-100 flex items-center transition">
            <svg class="w-5 h-5 mr-3" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"></path><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"></path><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.202,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"></path><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.902,35.619,44,29.592,44,24C44,22.659,43.862,21.35,43.611,20.083z"></path></svg>
            Google ê³„ì •ìœ¼ë¡œ ì‹œì‘í•˜ê¸°
        </button>
    </div>

    <!-- ë©”ì¸ ì•± ì»¨í…Œì´ë„ˆ (ì´ˆê¸°ì—ëŠ” ìˆ¨ê¹€) -->
    <div id="app-container" class="hidden h-screen flex">
        <!-- ì‚¬ì´ë“œë°” -->
        <aside id="sidebar" class="bg-white w-64 border-r flex-col shrink-0 hidden md:flex">
             <div class="p-4 border-b flex justify-between items-center">
                <h2 id="sidebar-title" class="text-xl font-bold text-blue-600"></h2>
            </div>
            <div id="sidebar-content" class="p-4">
                <!-- ì„ ìƒë‹˜/í•™ìƒë³„ ì‚¬ì´ë“œë°” ë‚´ìš© -->
            </div>
             <nav id="sidebar-nav" class="flex-grow p-2 overflow-y-auto">
                <!-- ë„¤ë¹„ê²Œì´ì…˜ ëª©ë¡ (ì˜ˆ: í”Œëœ ëª©ë¡) -->
            </nav>
            <div class="p-4 border-t mt-auto">
                 <span id="user-info" class="font-semibold text-sm mr-4"></span>
                <button id="logout-btn" class="w-full mt-2 bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600 transition text-sm">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </aside>

        <main id="content-area" class="flex-grow p-4 md:p-8 overflow-y-auto bg-gray-50">
            <!-- ì„ ìƒë‹˜/í•™ìƒ ë·°ê°€ ë Œë”ë§ë  ì˜ì—­ -->
        </main>
    </div>
    
    <!-- ì—­í•  ì„ íƒ ëª¨ë‹¬ -->
    <div id="role-selection-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-xl w-11/12 max-w-md p-8 text-center fade-in">
            <h3 class="text-2xl font-bold mb-4">Planit-tutorì— ì˜¤ì‹  ê²ƒì„ í™˜ì˜í•©ë‹ˆë‹¤!</h3>
            <p class="text-gray-600 mb-8">ì‹œì‘í•˜ê¸° ì „ì—, ë³¸ì¸ì˜ ì—­í• ì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
            <div class="flex justify-center gap-4">
                <button id="select-teacher-btn" class="w-full bg-blue-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-blue-700 transition">
                    ğŸ‘¨â€ğŸ« ì„ ìƒë‹˜ì…ë‹ˆë‹¤
                </button>
                <button id="select-student-btn" class="w-full bg-green-600 text-white font-bold py-4 px-6 rounded-lg hover:bg-green-700 transition">
                    ğŸ“ í•™ìƒì…ë‹ˆë‹¤
                </button>
            </div>
        </div>
    </div>
    
    <!-- í´ë˜ìŠ¤ ìƒì„± ëª¨ë‹¬ -->
    <div id="create-class-modal" class="modal-overlay hidden">
        <div class="bg-white rounded-2xl shadow-xl w-11/12 max-w-md p-6 fade-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold">ìƒˆ í´ë˜ìŠ¤ ë§Œë“¤ê¸°</h3>
                <button id="close-create-class-modal-btn" class="text-gray-500 hover:text-gray-800 text-2xl font-bold">&times;</button>
            </div>
            <div>
                <label for="class-name-input" class="block text-sm font-medium mb-1">í´ë˜ìŠ¤ ì´ë¦„</label>
                <input type="text" id="class-name-input" placeholder="ì˜ˆ: ê³ 3 ì´ê³¼ë°˜" class="w-full p-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                <p id="create-class-error" class="text-red-500 text-sm mt-2"></p>
            </div>
            <div class="mt-6 flex justify-end">
                <button id="confirm-create-class-btn" class="bg-blue-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-blue-700 transition">ìƒì„±í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
    <div id="loading-overlay" class="modal-overlay hidden">
        <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
    </div>
    
    <!-- í…œí”Œë¦¿ ì˜ì—­ -->
    <template id="teacher-dashboard-template">
        <div class="container mx-auto max-w-4xl">
            <div id="class-list-container" class="space-y-4">
                <!-- í´ë˜ìŠ¤ ëª©ë¡ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
        </div>
    </template>

    <template id="student-join-class-template">
        <div class="container mx-auto max-w-md text-center py-12">
            <h2 class="text-2xl font-bold mb-4">í´ë˜ìŠ¤ì— ì°¸ì—¬í•˜ì„¸ìš”!</h2>
            <p class="text-gray-600 mb-6">ì„ ìƒë‹˜ê»˜ ì „ë‹¬ë°›ì€ ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <div class="flex gap-2">
                <input type="text" id="invite-code-input" placeholder="ì´ˆëŒ€ ì½”ë“œ ì…ë ¥" class="w-full p-3 border border-gray-300 rounded-lg text-center font-mono tracking-widest focus:ring-2 focus:ring-green-500">
                <button id="join-class-btn" class="bg-green-600 text-white font-bold py-3 px-6 rounded-lg hover:bg-green-700 transition">ì°¸ì—¬í•˜ê¸°</button>
            </div>
             <p id="join-class-error" class="text-red-500 text-sm mt-3"></p>
        </div>
    </template>
    
    <!-- í•™ìƒ í”Œë˜ë„ˆ UI í…œí”Œë¦¿ -->
    <template id="student-planner-template">
         <div id="setup-container" class="bg-white p-6 rounded-2xl shadow-md mb-8 fade-in">
            <h2 class="text-xl font-semibold mb-4 border-b pb-2">ìƒˆë¡œìš´ í•™ìŠµ í”Œëœ ë§Œë“¤ê¸°</h2>
            <div class="space-y-4">
                <div>
                    <label for="planName" class="block text-sm font-medium mb-1">í”Œëœ ì´ë¦„</label>
                    <input type="text" id="planName" placeholder="ì˜ˆ: 2í•™ê¸° ì¤‘ê°„ê³ ì‚¬ ëŒ€ë¹„" class="w-full p-2 border rounded-lg focus:ring-2">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="startDate" class="block text-sm font-medium mb-1">ì‹œì‘ì¼</label>
                        <input type="date" id="startDate" class="w-full p-2 border rounded-lg focus:ring-2">
                    </div>
                    <div>
                        <label for="endDate" class="block text-sm font-medium mb-1">ì¢…ë£Œì¼</label>
                        <input type="date" id="endDate" class="w-full p-2 border rounded-lg focus:ring-2">
                    </div>
                </div>
                <button id="generatePlanBtn" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg transition">ê³„íš ìƒì„±í•˜ê¸°</button>
            </div>
        </div>
        <div id="plan-container"></div>
        <div id="initial-message" class="text-center py-12 bg-white rounded-2xl shadow-md fade-in">
            <p>ì™¼ìª½ ë©”ë‰´ì—ì„œ 'ìƒˆ í”Œëœ ë§Œë“¤ê¸°'ë¥¼ ëˆ„ë¥´ê±°ë‚˜<br>ê¸°ì¡´ í•™ìŠµ í”Œëœì„ ì„ íƒí•´ì£¼ì„¸ìš”.</p>
        </div>
    </template>

    <template id="week-template">
        <details class="bg-white p-4 md:p-6 rounded-2xl shadow-md mb-6 fade-in" open>
            <summary class="flex justify-between items-center cursor-pointer">
                <h2 class="text-lg md:text-xl font-bold">
                    <span class="week-index"></span>ì£¼ì°¨ ê³„íš 
                    <span class="text-sm font-normal text-gray-500 date-range"></span>
                </h2>
                <span class="text-blue-500 transform transition-transform duration-300">â–¼</span>
            </summary>
            <div class="mt-6">
                <div class="flex flex-wrap gap-2 mb-3">
                    <input type="text" placeholder="ì´ë²ˆ ì£¼ì— í•  ì¼ì„ ì…ë ¥í•˜ì„¸ìš”" class="task-input flex-grow p-2 border rounded-lg">
                    <button class="add-task-btn bg-blue-500 text-white px-4 py-2 rounded-lg transition shrink-0" data-type="weekly">ì¶”ê°€</button>
                </div>
                <ul class="task-list mt-3 space-y-2"></ul>
                <div class="daily-plan-grid grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mt-6"></div>
            </div>
        </details>
    </template>

    <template id="day-template">
        <div class="bg-gray-100 p-4 rounded-lg border flex flex-col">
            <h4 class="font-semibold mb-3 day-header"></h4>
            <div class="flex gap-2 mb-3">
                <input type="text" placeholder="ì˜¤ëŠ˜ í•  ì¼" class="task-input w-full text-sm p-2 border rounded-md">
                <input type="number" placeholder="ë¶„" class="task-time-input w-16 text-sm p-2 border rounded-md text-center">
                <button class="add-task-btn bg-gray-300 text-gray-700 text-sm px-3 py-1 rounded-md transition shrink-0" data-type="daily">ì¶”ê°€</button>
            </div>
            <ul class="task-list space-y-2 flex-grow min-h-[50px]"></ul>
        </div>
    </template>

    <template id="task-item-template">
        <li class="task-item flex items-center p-2 rounded-md transition hover:bg-gray-50">
            <button class="task-status text-lg font-bold w-6 text-center text-gray-400"></button>
            <span class="task-text ml-2 flex-grow"></span>
            <span class="task-time text-xs text-gray-500 ml-2"></span>
            <button class="delete-task-btn text-gray-400 hover:text-red-500 transition ml-2 text-lg shrink-0">Ã—</button>
        </li>
    </template>


    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, query, where, getDocs, addDoc, updateDoc, writeBatch } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // --- âš™ï¸ ì•± ì„¤ì • ---
        const firebaseConfig = {
            apiKey: "AIzaSyAAy3JLjWNDxdUqseyWp4xOYsjTMF6kGVE",
            authDomain: "plan-it-app-519cc.firebaseapp.com",
            projectId: "plan-it-app-519cc",
            storageBucket: "plan-it-app-519cc.appspot.com",
            messagingSenderId: "778034395079",
            appId: "1:778034395079:web:11aff27bd5781dba8f8be2"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- ì „ì—­ ë³€ìˆ˜ ---
        let currentUser = null;
        let currentUserData = null;
        let currentStudentData = null; // í•™ìƒ ë°ì´í„°ë¥¼ ë‹´ì„ ë³€ìˆ˜
        const DAY_NAMES = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const STATUS_MAP = { 0: { icon: 'â—‹' }, 1: { icon: 'â–³' }, 2: { icon: 'â—' } };

        // --- DOM ìš”ì†Œ ---
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginBtn = document.getElementById('login-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const roleSelectionModal = document.getElementById('role-selection-modal');
        const selectTeacherBtn = document.getElementById('select-teacher-btn');
        const selectStudentBtn = document.getElementById('select-student-btn');
        const userInfo = document.getElementById('user-info');
        const contentArea = document.getElementById('content-area');
        const loadingOverlay = document.getElementById('loading-overlay');
        const createClassModal = document.getElementById('create-class-modal');
        const closeCreateClassModalBtn = document.getElementById('close-create-class-modal-btn');
        const confirmCreateClassBtn = document.getElementById('confirm-create-class-btn');
        const classNameInput = document.getElementById('class-name-input');
        const createClassError = document.getElementById('create-class-error');
        const sidebar = document.getElementById('sidebar');
        const sidebarTitle = document.getElementById('sidebar-title');
        const sidebarContent = document.getElementById('sidebar-content');
        const sidebarNav = document.getElementById('sidebar-nav');

        // --- ì¸ì¦ ìƒíƒœ ê´€ë¦¬ (í•µì‹¬ ë¡œì§) ---
        onAuthStateChanged(auth, user => {
            if (user) {
                currentUser = user;
                loginContainer.classList.add('hidden');
                checkUserRole(user);
            } else {
                currentUser = null;
                currentUserData = null;
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                hideLoading();
            }
        });

        async function checkUserRole(user) {
            showLoading();
            const userDocRef = doc(db, "users", user.uid);
            const docSnap = await getDoc(userDocRef);

            if (docSnap.exists() && docSnap.data().role) {
                currentUserData = docSnap.data();
                hideRoleSelectionModal();
                loadAppForRole(currentUserData, user);
            } else {
                showRoleSelectionModal(user);
            }
            hideLoading();
        }
        
        async function loadAppForRole(userData, user) {
            appContainer.style.display = 'flex';
            const roleText = userData.role === 'teacher' ? 'ì„ ìƒë‹˜' : 'í•™ìƒ';
            userInfo.textContent = `${user.displayName || 'ì‚¬ìš©ì'} (${roleText})`;
            
            if (userData.role === 'teacher') {
                sidebar.classList.remove('hidden');
                sidebarTitle.textContent = "ğŸ“ ë‚´ í´ë˜ìŠ¤";
                renderTeacherDashboard(user);
            } else if (userData.role === 'student') {
                sidebar.classList.remove('hidden');
                sidebarTitle.textContent = "ğŸ“š ë‚´ í•™ìŠµ í”Œëœ";
                if (userData.classId) {
                    await loadStudentData(userData.classId, user.uid); // í•™ìƒ ë°ì´í„° ë¡œë“œ
                    renderStudentPlanner(user);
                } else {
                    sidebar.classList.add('hidden'); // í´ë˜ìŠ¤ ì—†ìœ¼ë©´ ì‚¬ì´ë“œë°” ìˆ¨ê¹€
                    renderJoinClassView(user);
                }
            }
        }

        async function handleRoleSelection(user, selectedRole) {
            showLoading();
            const userDocRef = doc(db, "users", user.uid);
            try {
                const newUserData = {
                    uid: user.uid,
                    displayName: user.displayName || 'ì´ë¦„ ì—†ìŒ',
                    email: user.email,
                    role: selectedRole,
                    createdAt: new Date()
                };
                await setDoc(userDocRef, newUserData, { merge: true });
                
                currentUserData = newUserData;
                hideRoleSelectionModal();
                loadAppForRole(currentUserData, user);

            } catch (error) {
                console.error("ì—­í•  ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                alert("ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
            hideLoading();
        }
        
        // --- ì„ ìƒë‹˜ ê¸°ëŠ¥ ---
        function renderTeacherDashboard(user) {
            sidebarContent.innerHTML = `
                <button id="show-create-class-modal-btn" class="w-full bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition">
                    + ìƒˆ í´ë˜ìŠ¤ ë§Œë“¤ê¸°
                </button>
            `;
            document.getElementById('show-create-class-modal-btn').addEventListener('click', () => {
                createClassModal.classList.remove('hidden');
            });

            const template = document.getElementById('teacher-dashboard-template');
            contentArea.innerHTML = '';
            contentArea.appendChild(template.content.cloneNode(true));
            loadAndRenderClasses(user);
        }

        async function loadAndRenderClasses(user) {
            showLoading();
            const classListContainer = document.getElementById('class-list-container');
            if (!classListContainer) return;
            classListContainer.innerHTML = ''; 
            
            const classesRef = collection(db, "classes");
            const q = query(classesRef, where("teacherId", "==", user.uid));

            try {
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    classListContainer.innerHTML = `<p class="text-center text-gray-500 py-8 bg-white rounded-lg shadow">ì•„ì§ ìƒì„±ëœ í´ë˜ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                } else {
                    for (const doc of querySnapshot.docs) {
                        const classData = doc.data();
                        const classId = doc.id;
                        
                        const studentsSnapshot = await getDocs(collection(db, "classes", classId, "students"));
                        const studentCount = studentsSnapshot.size;

                        const classElement = document.createElement('div');
                        classElement.className = 'bg-white p-6 rounded-lg shadow-md';
                        classElement.innerHTML = `
                            <div class="flex justify-between items-start">
                                <div>
                                    <h3 class="text-xl font-bold text-gray-800">${classData.className}</h3>
                                    <p class="text-sm text-gray-500 mt-1">í•™ìƒ ìˆ˜: ${studentCount}ëª…</p>
                                </div>
                                <div class="text-right">
                                    <p class="text-sm font-semibold">í•™ìƒ ì´ˆëŒ€ ì½”ë“œ</p>
                                    <div class="mt-1 p-2 bg-gray-100 rounded-md font-mono text-blue-600 cursor-pointer" title="í´ë¦­í•˜ì—¬ ë³µì‚¬">
                                        ${classId}
                                    </div>
                                </div>
                            </div>
                        `;
                        classListContainer.appendChild(classElement);
                    }
                }
            } catch (error) {
                console.error("í´ë˜ìŠ¤ ëª©ë¡ ë¡œë”© ì˜¤ë¥˜: ", error);
                classListContainer.innerHTML = `<p class="text-red-500">í´ë˜ìŠ¤ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>`;
            }
            hideLoading();
        }
        
        async function createNewClass(user) {
            const className = classNameInput.value.trim();
            if (!className) {
                createClassError.textContent = 'í´ë˜ìŠ¤ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }
            
            showLoading();
            createClassError.textContent = '';

            try {
                await addDoc(collection(db, "classes"), {
                    className: className,
                    teacherId: user.uid,
                    createdAt: new Date()
                });
                
                hideCreateClassModal();
                loadAndRenderClasses(user);

            } catch (error) {
                console.error("í´ë˜ìŠ¤ ìƒì„± ì˜¤ë¥˜: ", error);
                createClassError.textContent = 'í´ë˜ìŠ¤ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }
            hideLoading();
        }

        // --- í•™ìƒ ê¸°ëŠ¥ ---
        function renderJoinClassView(user) {
            contentArea.innerHTML = '';
            const template = document.getElementById('student-join-class-template');
            contentArea.appendChild(template.content.cloneNode(true));
            document.getElementById('join-class-btn').addEventListener('click', () => handleJoinClass(user));
        }

        async function handleJoinClass(user) {
            const inviteCodeInput = document.getElementById('invite-code-input');
            const errorElement = document.getElementById('join-class-error');
            const classCode = inviteCodeInput.value.trim();
            if (!classCode) {
                errorElement.textContent = 'ì´ˆëŒ€ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.';
                return;
            }

            showLoading();
            errorElement.textContent = '';
            
            const classDocRef = doc(db, "classes", classCode);
            try {
                const classDocSnap = await getDoc(classDocRef);
                if (!classDocSnap.exists()) {
                    errorElement.textContent = 'ìœ íš¨í•˜ì§€ ì•Šì€ ì´ˆëŒ€ ì½”ë“œì…ë‹ˆë‹¤.';
                    hideLoading();
                    return;
                }
                
                const studentData = {
                    uid: user.uid,
                    displayName: user.displayName || 'ì´ë¦„ ì—†ìŒ',
                    joinedAt: new Date(),
                    studyPlans: [], // í•™ìƒ ë°ì´í„° ì´ˆê¸°í™”
                    activePlanId: null
                };

                const studentInClassRef = doc(db, "classes", classCode, "students", user.uid);
                await setDoc(studentInClassRef, studentData);

                const userDocRef = doc(db, "users", user.uid);
                await updateDoc(userDocRef, { classId: classCode });

                const updatedUserDoc = await getDoc(userDocRef);
                currentUserData = updatedUserDoc.data();
                loadAppForRole(currentUserData, user);

            } catch (error) {
                console.error("í´ë˜ìŠ¤ ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ:", error);
                errorElement.textContent = 'ì°¸ì—¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.';
            } finally {
                 hideLoading();
            }
        }
        
        // --- í•™ìƒ í”Œë˜ë„ˆ ê¸°ëŠ¥ (v1.0) ---
        async function loadStudentData(classId, studentId) {
            const studentDocRef = doc(db, "classes", classId, "students", studentId);
            const docSnap = await getDoc(studentDocRef);
            if (docSnap.exists()) {
                currentStudentData = docSnap.data();
                 if (!currentStudentData.studyPlans) currentStudentData.studyPlans = [];
            } else {
                 console.log("í•™ìƒ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ìƒˆë¡œ ìƒì„±í•©ë‹ˆë‹¤.");
                 currentStudentData = { studyPlans: [], activePlanId: null };
            }
        }

        function getStudentDataRef() {
            if (!currentUserData.classId || !currentUser.uid) return null;
            return doc(db, "classes", currentUserData.classId, "students", currentUser.uid);
        }

        function renderStudentPlanner(user) {
            contentArea.innerHTML = '';
            const template = document.getElementById('student-planner-template');
            contentArea.appendChild(template.content.cloneNode(true));
            
            sidebarContent.innerHTML = `
                <button id="new-plan-btn" class="w-full bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition">
                    + ìƒˆ í”Œëœ ë§Œë“¤ê¸°
                </button>
            `;

            document.getElementById('new-plan-btn').addEventListener('click', showSetupView);
            document.getElementById('generatePlanBtn').addEventListener('click', createNewPlanForStudent);
            
            renderStudentSidebar();

            if (currentStudentData.activePlanId) {
                loadPlanById(currentStudentData.activePlanId);
            } else {
                showInitialView();
            }
        }
        
        function renderStudentSidebar() {
            sidebarNav.innerHTML = '';
            const planList = document.createElement('ul');
            planList.className = 'space-y-1';
            
            if (currentStudentData.studyPlans) {
                currentStudentData.studyPlans.forEach(plan => {
                    const li = document.createElement('li');
                    li.className = `plan-item p-3 rounded-md cursor-pointer`;
                    if (plan.id === currentStudentData.activePlanId) li.classList.add('active');
                    li.dataset.planId = plan.id;
                    li.innerHTML = `<div class="flex justify-between items-center">
                                      <span class="font-semibold truncate">${plan.name}</span>
                                      <button class="delete-plan-btn text-gray-400 hover:text-red-500 font-bold shrink-0 text-lg">Ã—</button>
                                  </div>`;
                    planList.appendChild(li);
                });
            }
            sidebarNav.appendChild(planList);

            planList.addEventListener('click', (e) => {
                const planItem = e.target.closest('.plan-item');
                const deleteBtn = e.target.closest('.delete-plan-btn');

                if (deleteBtn) {
                     e.stopPropagation();
                     deletePlan(planItem.dataset.planId);
                } else if (planItem) {
                    loadPlanById(planItem.dataset.planId);
                }
            });
        }
        
        async function createNewPlanForStudent() {
            const planName = document.getElementById('planName').value.trim();
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            if (!startDate || !endDate || new Date(startDate) > new Date(endDate)) {
                 alert('ì˜¬ë°”ë¥¸ ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            const newPlan = {
                id: Date.now().toString(),
                name: planName || `${startDate} ~ ${endDate}`,
                startDate,
                endDate,
                tasks: {}
            };
            
            currentStudentData.studyPlans.unshift(newPlan);
            currentStudentData.activePlanId = newPlan.id;
            
            const studentDocRef = getStudentDataRef();
            await updateDoc(studentDocRef, {
                studyPlans: currentStudentData.studyPlans,
                activePlanId: newPlan.id
            });
            
            renderStudentSidebar();
            loadPlanById(newPlan.id);
        }
        
        function getActivePlan() {
            return currentStudentData.studyPlans.find(p => p.id === currentStudentData.activePlanId);
        }

        function loadPlanById(planId) {
            currentStudentData.activePlanId = planId;
            const studentDocRef = getStudentDataRef();
            updateDoc(studentDocRef, { activePlanId: planId }); // ë¹„ë™ê¸°ë¡œ í™œì„± í”Œëœ ID ì €ì¥
            
            renderStudentSidebar();
            
            const plan = getActivePlan();
            if (plan) {
                renderPlan(plan);
            } else {
                showInitialView();
            }
        }
        
        async function deletePlan(planId) {
            currentStudentData.studyPlans = currentStudentData.studyPlans.filter(p => p.id !== planId);
            const newActiveId = currentStudentData.studyPlans.length > 0 ? currentStudentData.studyPlans[0].id : null;
            currentStudentData.activePlanId = newActiveId;

            const studentDocRef = getStudentDataRef();
            await updateDoc(studentDocRef, {
                studyPlans: currentStudentData.studyPlans,
                activePlanId: newActiveId
            });
            
            renderStudentSidebar();
            if (newActiveId) {
                loadPlanById(newActiveId);
            } else {
                showInitialView();
            }
        }

        function showInitialView() {
            document.getElementById('initial-message').style.display = 'block';
            document.getElementById('setup-container').style.display = 'none';
            document.getElementById('plan-container').innerHTML = '';
        }

        function showSetupView() {
            document.getElementById('initial-message').style.display = 'none';
            document.getElementById('setup-container').style.display = 'block';
            document.getElementById('plan-container').innerHTML = '';
            document.getElementById('planName').value = '';
            document.getElementById('startDate').value = '';
            document.getElementById('endDate').value = '';
        }
        
        function renderPlan(plan) {
            showInitialView();
            document.getElementById('initial-message').style.display = 'none';
            const planContainer = document.getElementById('plan-container');
            planContainer.innerHTML = '';
            
            const startDate = new Date(plan.startDate + 'T00:00:00');
            const endDate = new Date(plan.endDate + 'T00:00:00');
            let currentWeekStart = new Date(startDate);
            let dayOfWeek = currentWeekStart.getDay();
            currentWeekStart.setDate(currentWeekStart.getDate() - dayOfWeek);
            
            let weekIndex = 0;
            while(currentWeekStart <= endDate) {
                const weekId = `week-${weekIndex}`;
                planContainer.appendChild(createWeekElement(currentWeekStart, weekIndex, startDate, endDate, plan));
                currentWeekStart.setDate(currentWeekStart.getDate() + 7);
                weekIndex++;
            }
            planContainer.addEventListener('click', handlePlanContainerClick);
        }

        function createWeekElement(weekStartDate, weekIndex, planStartDate, planEndDate, plan) {
            const weekEndDate = new Date(weekStartDate);
            weekEndDate.setDate(weekStartDate.getDate() + 6);
            const weekId = `week-${weekIndex}`;

            const template = document.getElementById('week-template').content.cloneNode(true);
            const weekElement = template.firstElementChild;
            
            weekElement.querySelector('.week-index').textContent = weekIndex + 1;
            weekElement.querySelector('.date-range').textContent = `(${formatDate(weekStartDate)} ~ ${formatDate(weekEndDate)})`;
            
            const weeklyTaskList = weekElement.querySelector('.task-list');
            weeklyTaskList.id = weekId;
            weekElement.querySelector('.add-task-btn').dataset.target = weekId;
            
            (plan.tasks[weekId] || []).forEach(task => addTaskToDOM(weeklyTaskList, task, 'weekly'));

            const dailyGrid = weekElement.querySelector('.daily-plan-grid');
            for (let i = 0; i < 7; i++) {
                const currentDate = new Date(weekStartDate);
                currentDate.setDate(weekStartDate.getDate() + i);
                if (currentDate >= planStartDate && currentDate <= planEndDate) {
                    dailyGrid.appendChild(createDayElement(currentDate, `day-${weekIndex}-${i}`, plan));
                }
            }
            return weekElement;
        }

        function createDayElement(date, dayId, plan) {
            const template = document.getElementById('day-template').content.cloneNode(true);
            const dayElement = template.firstElementChild;

            dayElement.querySelector('.day-header').textContent = `${formatDate(date)} (${DAY_NAMES[date.getDay()]})`;
            
            const taskList = dayElement.querySelector('.task-list');
            taskList.id = dayId;
            dayElement.querySelector('.add-task-btn').dataset.target = dayId;
            
            (plan.tasks[dayId] || []).forEach(task => addTaskToDOM(taskList, task, 'daily'));

            return dayElement;
        }

        function handlePlanContainerClick(e) {
            const target = e.target;
            const addTaskBtn = target.closest('.add-task-btn');
            const taskItem = target.closest('.task-item');

            if (addTaskBtn) {
                handleAddTask(addTaskBtn);
            } else if (taskItem) {
                if (target.matches('.delete-task-btn')) {
                    taskItem.remove();
                    saveCurrentPlanTasks();
                } else if (target.matches('.task-status')) {
                    let currentStatus = parseInt(taskItem.dataset.status);
                    taskItem.dataset.status = (currentStatus + 1) % 3;
                    target.textContent = STATUS_MAP[taskItem.dataset.status].icon;
                    saveCurrentPlanTasks();
                }
            }
        }

        function handleAddTask(button) {
            const container = button.closest('div');
            const input = container.querySelector('.task-input');
            const timeInput = container.querySelector('.task-time-input');
            const taskText = input.value.trim();
            const taskType = button.dataset.type;

            if (taskText) {
                const task = {
                    text: taskText,
                    status: 0,
                    time: timeInput ? (parseInt(timeInput.value) || 0) : 0,
                };
                const list = document.getElementById(button.dataset.target);
                addTaskToDOM(list, task, taskType);
                input.value = '';
                if(timeInput) timeInput.value = '';
                input.focus();
                saveCurrentPlanTasks();
            }
        }
        
        function addTaskToDOM(list, task, type) {
            if (!list) return;
            const template = document.getElementById('task-item-template').content.cloneNode(true);
            const taskElement = template.firstElementChild;

            taskElement.dataset.status = task.status;
            taskElement.querySelector('.task-status').textContent = STATUS_MAP[task.status].icon;
            taskElement.querySelector('.task-text').textContent = task.text;
            
            const timeDisplay = taskElement.querySelector('.task-time');
            if (type === 'daily' && task.time > 0) {
                timeDisplay.textContent = `(${task.time}ë¶„)`;
            } else {
                timeDisplay.remove();
            }
            list.appendChild(taskElement);
        }

        async function saveCurrentPlanTasks() {
            const plan = getActivePlan();
            if (!plan) return;

            plan.tasks = {};
            document.querySelectorAll('#plan-container .task-list').forEach(list => {
                plan.tasks[list.id] = Array.from(list.querySelectorAll('.task-item')).map(item => {
                    const text = item.querySelector('.task-text').textContent;
                    const status = parseInt(item.dataset.status);
                    const timeText = item.querySelector('.task-time');
                    const time = timeText ? parseInt(timeText.textContent.match(/\d+/)[0]) : 0;
                    return { text, status, time };
                });
            });

            const studentDocRef = getStudentDataRef();
            await updateDoc(studentDocRef, { studyPlans: currentStudentData.studyPlans });
        }
        
        function formatDate(date) { return date.toISOString().split('T')[0]; }


        // --- ëª¨ë‹¬ ì»¨íŠ¸ë¡¤ ---
        function showRoleSelectionModal(user) {
            roleSelectionModal.classList.remove('hidden');
            selectTeacherBtn.onclick = () => handleRoleSelection(user, 'teacher');
            selectStudentBtn.onclick = () => handleRoleSelection(user, 'student');
        }
        function hideRoleSelectionModal() {
            roleSelectionModal.classList.add('hidden');
        }
        function hideCreateClassModal() {
            createClassModal.classList.add('hidden');
            classNameInput.value = '';
            createClassError.textContent = '';
        }
        function showLoading() { loadingOverlay.classList.remove('hidden'); }
        function hideLoading() { loadingOverlay.classList.add('hidden'); }

        // --- ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---
        loginBtn.addEventListener('click', () => {
            const provider = new GoogleAuthProvider();
            signInWithPopup(auth, provider).catch(error => {
                console.error("Google ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
            });
        });
        logoutBtn.addEventListener('click', () => { signOut(auth); });
        closeCreateClassModalBtn.addEventListener('click', hideCreateClassModal);
        confirmCreateClassBtn.addEventListener('click', () => {
             if (auth.currentUser) createNewClass(auth.currentUser);
        });

    </script>
</body>
</html>

